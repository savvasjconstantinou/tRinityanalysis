#we wanted to see what the effects were of the 3 en group as their measures seem visually different from most other time points. Do the 3 en
#animals 'pull' the pre-molt thoracic group to be different from the post-molt thoracic group (remove 3 en). Are they different enough to
#be considered their own "tagma group"?
#analysis is replicate of analysis to produce PCA from publication, with 2 additional data analysis done following it

#install and load required packages- thank you to the package developers!
install.packages("graphics")
install.packages("devtools")
install.packages("cowplot")
install.packages("gridExtra")

library(graphics)
library(devtools)
install_github("ggbiplot", "vqv")
library(ggbiplot)
library(cowplot)
library(gridExtra)

#create file for TP analysis

#merge all data, change col names to be more readable, check
setwd("C:/Users/Savvas Constantinou/Documents/exported csv data for SC/raw data for full")
filenames <- list.files(path="C:/Users/Savvas Constantinou/Documents/exported csv data for SC/raw data for full")
colnames<-c("BL","EN","GZ.L","GZ.L.cells","GZWA","GZWA.cells","GZWB","GZWB.cells","GZA","LSL","LSL.cells","LSA","TrunkA","GZDAPI","# mit AP","% mit AP","GZpH3")
data<-do.call(rbind, lapply(filenames, function(x) read.csv(x, col.names = colnames, stringsAsFactors = T)))
head(data)

#identify extreme outliers in columns 1-13 without EN or cell length
boxplot(data[,1]~as.factor(data[,2]))
boxplot(data[,3]~as.factor(data[,2]))
boxplot(data[,5]~as.factor(data[,2]))
boxplot(data[,7]~as.factor(data[,2]))
boxplot(as.numeric(data[,9])~as.factor(data[,2]))
boxplot(data[,10]~as.factor(data[,2]))
boxplot(as.numeric(data[,12])~as.factor(data[,2]))
boxplot(as.numeric(data[,13])~as.factor(data[,2]))

#identified 4 misentered values from raw data:
#5 en, BL 0.401 change to 0.41
#5 en, BL, 0.0433 change to 0.433
#10 en, GZWA, 112 change to 0.112
#14 en, LSA, 138 change to 0.00138

#make copies of original data in new folder, make changes,remerge into data called "full", export data
setwd("C:/Users/Savvas Constantinou/Documents/exported csv data for SC/raw data for full2")
filename <- list.files(path="C:/Users/Savvas Constantinou/Documents/exported csv data for SC/raw data for full2")
colnames<-c("BL","EN","GZ.L","GZ.L.cells","GZWA","GZWA.cells","GZWB","GZWB.cells","GZA","LSL","LSL.cells","LSA","TrunkA","GZDAPI","# mit AP","% mit AP","GZpH3")
full<-do.call(rbind, lapply(filename, function(x) read.csv(x, col.names = colnames)))
write.csv(full, file="full.csv")

#add tagma groupings (see methods for categories), remove column 1 (duplicate of row names), remove "*" on data
full<-read.csv("C:/Users/Savvas Constantinou/Documents/exported csv data for SC/raw data for full2/full.csv", header=T, stringsAsFactors =F)

#add +1 to LSL cells (to account for en expressing cell of segment), check data
full$LSL.cells<- as.numeric(full$LSL.cells) + 1
head(full)
str(full)

#remove rows where NA are present, exclude dapi, AP oriented and %, pH3 and tagma
athing<-na.omit(full[,1:13])
str(athing)

#do PCA, scale and center data. check contribution of each principal component.
myPCA<-prcomp(athing, scale=TRUE, center=TRUE)
summary(myPCA)

#create a vector of the group names that excludes the rows with NAs (identified visually by comparing 'thing/athing' to 'notfull' dataset)
naout<- full[ c(1:30, 32:40, 42:53, 55:90, 92:395, 397:428), 18]

#plot PC1 and PC2, color data by tagma. include probability ellipse of 68%

group<-as.factor(naout)

gg <- ggbiplot(myPCA, obs.scale=1, var.scale=1, groups=group, 
               ellipse=TRUE) +
  scale_color_discrete(name='')  +
  theme(legend.position= c(.85,.89)) 
gg


#look at screeplot to determine how many PC to keep for future analysis (if <1 retain; but one should also retain as many PC
#as necessary to explain 80-90% of variance- use summary of myPCA...)
screeplot(myPCA)

#multiple comparisons of PC1, PC2, PC3, and PC4 (to explain >90% variance) by group. If sig p-value in Anova (Type II), than the groups are not the same
a<-manova((myPCA$x[,1:4])~group)
summary(a)

#how much of the variance of a PC is explained by group? How dissimilar are the groups from each other in the dimension of a PC?
summary( lm( myPCA$x[,1] ~ group) )
summary( lm( myPCA$x[,2] ~ group) )

#summary- best to include EN in analysis. If so, PC1 explains ~62% (line 59) of the variance of all the data AND ~79% of the variance in PC1 is explained 
#by group (adj R2 sqrd from line 84). By PC1, each tagma is different from each other statistically.
#These analysis statistically justify the separation of tagma that we chose based on the biology. These are grounds for doing by tagma ANOVA.

#check to see what happens to PCA if 3 en is removed
a<-subset.data.frame(full, full$EN>3)
aa<- na.omit(a[,1:13])

myPCAa<-prcomp(aa, scale=TRUE, center=TRUE)
summary(myPCAa)

#create a vector of the group names that excludes the rows with NAs (same as above but exclude 217-240 which are the 3 en animals)
naoutaa<- full[ c(1:30, 32:40, 42:53, 55:90, 92:216, 241:395, 397:428), 18]

#plot PC1 and PC2, color data by tagma. include probability ellipse of 68%


groupa<-as.factor(naoutaa)

gga <- ggbiplot(myPCAa, obs.scale=1, var.scale=1, groups=groupa, 
               ellipse=TRUE) +
  scale_color_discrete(name='')  +
  theme(legend.position= c(.85,.89)) 
gga

aaa<-manova((myPCAa$x[,1:4])~groupa)
summary(aaa)

#how much of the variance of a PC is explained by group? How dissimilar are the groups from each other in the dimension of a PC?
summary( lm( myPCAa$x[,1] ~ groupa) )
summary( lm( myPCAa$x[,2] ~ groupa) )

#what if 3 en is its own group?
full3en<- full<-read.csv("C:/Users/Savvas Constantinou/Documents/exported csv data for SC/raw data for full2/full3en.csv", header=T, stringsAsFactors =F)
full3en$LSL.cells<- as.numeric(full3en$LSL.cells) + 1
head(full3en)

b<-na.omit(full3en[,1:13])
myPCAb<-prcomp(b, scale=T, center=T)
summary(myPCAb)

naoutb<- full3en[ c(1:30, 32:40, 42:53, 55:90, 92:395, 397:428), 18]
groupb<-as.factor(naoutb)

ggb <- ggbiplot(myPCAb, obs.scale=1, var.scale=1, groups=groupb, 
               ellipse=TRUE) +
  scale_color_discrete(name='')  +
  theme(legend.position= c(.85,.89)) 
ggb

bbb<-manova((myPCAb$x[,1:4])~groupb)
summary(bbb)

#how much of the variance of a PC is explained by group? How dissimilar are the groups from each other in the dimension of a PC?
summary( lm( myPCAb$x[,1] ~ groupb) )
summary( lm( myPCAb$x[,2] ~ groupb) )

grid.arrange(gg, gga, ggb)
